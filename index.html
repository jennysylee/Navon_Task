<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Navon Task Experiment</title>
    <style>
        :root {
            --color-bg-primary: #f5f5f5;
            --color-bg-secondary: #ffffff;
            --color-text-primary: #2c3e50;
            --color-text-secondary: #555555;
            --color-primary: #2980b9;
            --color-primary-hover: #1f618d;
            --color-success: #27ae60;
            --color-error: #e74c3c;
            --color-warning: #f39c12;
            --color-border: #ddd;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background-color: var(--color-bg-primary);
            color: var(--color-text-primary);
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background-color: var(--color-bg-secondary);
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: var(--color-primary);
            font-size: 2.5em;
        }

        h2 {
            color: var(--color-primary);
            margin-top: 25px;
            margin-bottom: 15px;
            font-size: 1.5em;
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        /* Participant ID Entry */
        .form-group {
            margin-bottom: 20px;
            text-align: center;
        }

        label {
            display: block;
            font-weight: bold;
            margin-bottom: 8px;
            font-size: 1.1em;
        }

        input[type="text"] {
            width: 150px;
            padding: 10px;
            font-size: 1.1em;
            text-align: center;
            border: 2px solid var(--color-border);
            border-radius: 4px;
            letter-spacing: 2px;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 5px rgba(41, 128, 185, 0.3);
        }

        /* Instructions */
        .instructions {
            background-color: #f0f8ff;
            padding: 20px;
            border-left: 4px solid var(--color-primary);
            margin: 20px 0;
            line-height: 1.8;
            font-size: 1.05em;
        }

        .instructions p {
            margin-bottom: 12px;
        }

        .key-instruction {
            background-color: #fffacd;
            padding: 15px;
            border-radius: 4px;
            margin: 15px 0;
            font-weight: bold;
            text-align: center;
            font-size: 1.1em;
        }

        /* Stimulus Display */
        .stimulus-container {
            text-align: center;
            margin: 40px 0;
            min-height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #f0f0f0;
            border-radius: 8px;
            position: relative;
        }

        .stimulus-text {
            font-family: Arial, sans-serif;
            font-weight: bold;
            color: #000;
            line-height: 1;
        }

        .feedback-message {
            text-align: center;
            font-size: 1.8em;
            font-weight: bold;
            padding: 20px;
            border-radius: 4px;
            margin: 20px 0;
        }

        .feedback-correct {
            background-color: #d4edda;
            color: var(--color-success);
        }

        .feedback-wrong {
            background-color: #f8d7da;
            color: var(--color-error);
        }

        .feedback-tooslow {
            background-color: #fff3cd;
            color: var(--color-warning);
        }

        /* Buttons */
        button {
            background-color: var(--color-primary);
            color: white;
            border: none;
            padding: 12px 30px;
            font-size: 1em;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
            margin: 10px 5px;
        }

        button:hover {
            background-color: var(--color-primary-hover);
        }

        button:disabled {
            background-color: #999;
            cursor: not-allowed;
        }

        .button-container {
            text-align: center;
            margin-top: 30px;
        }

        /* Progress */
        .progress-info {
            text-align: center;
            font-size: 1.1em;
            margin: 20px 0;
            color: var(--color-text-secondary);
        }

        /* Results Table */
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }

        table th, table td {
            border: 1px solid var(--color-border);
            padding: 12px;
            text-align: center;
        }

        table th {
            background-color: var(--color-primary);
            color: white;
            font-weight: bold;
        }

        table tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        table tr:hover {
            background-color: #f0f0f0;
        }

        /* Feedback Results */
        .feedback-section {
            background-color: #f0f8ff;
            padding: 25px;
            border-radius: 8px;
            margin: 20px 0;
        }

        .feedback-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid var(--color-border);
            font-size: 1.05em;
        }

        .feedback-row:last-child {
            border-bottom: none;
        }

        .feedback-label {
            font-weight: bold;
            color: var(--color-primary);
        }

        .feedback-value {
            color: var(--color-text-primary);
            font-weight: bold;
        }

        .print-button {
            background-color: var(--color-success);
            margin-top: 20px;
        }

        .print-button:hover {
            background-color: #229954;
        }

        .restart-button {
            background-color: var(--color-primary);
        }

        /* Participant Info Display */
        .participant-info {
            background-color: #e8f4f8;
            padding: 15px;
            border-radius: 4px;
            margin: 20px 0;
            text-align: center;
            font-size: 1.1em;
            font-weight: bold;
        }

        .participant-info span {
            color: var(--color-primary);
        }

        .trial-counter {
            font-size: 1.2em;
            color: var(--color-primary);
            margin: 10px 0;
        }

        .error-message {
            color: var(--color-error);
            text-align: center;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid var(--color-error);
            border-radius: 4px;
            background-color: #ffe0e0;
        }

        @media print {
            body {
                background-color: white;
            }
            .container {
                box-shadow: none;
            }
            button {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Participant ID Entry -->
        <div id="entrySection" class="section active">
            <h1>Navon Task Experiment</h1>
            <div class="instructions">
                <p><strong>Welcome to the Navon Task Experiment</strong></p>
                <p>This experiment tests whether you perceive the global (large) or local (small) structure of visual stimuli first.</p>
                <p>In this task, you will see large letters made up of small letters. Your job is to identify the presence of a target letter, which may appear at either the global (large) or local (small) level.</p>
            </div>

            <div class="form-group">
                <label for="participantId">Enter Participant Number (3 digits):</label>
                <input type="text" id="participantId" maxlength="3" placeholder="000" pattern="[0-9]{3}">
                <div id="idError" class="error-message" style="display: none;">Please enter exactly 3 digits (0-9)</div>
            </div>

            <div class="button-container">
                <button onclick="startExperiment()">Start Experiment</button>
            </div>
        </div>

        <!-- Instructions Section -->
        <div id="instructionSection" class="section">
            <h1>Navon Task - Instructions</h1>
            <div class="participant-info">
                Participant Number: <span id="displayParticipantId"></span>
            </div>

            <div class="instructions">
                <h2>Task Overview</h2>
                <p>You will see a series of large letters, each composed of small letters. Your task is to identify whether a target letter appears in each stimulus.</p>
                
                <h2>Target Letters</h2>
                <p><strong>Global Level Target:</strong> Letter H or O at the large scale</p>
                <p><strong>Local Level Target:</strong> Letter h or o at the small scale</p>
                <p><strong>No Target:</strong> No target letter present</p>

                <h2>Your Task</h2>
                <p>When you see each stimulus, press one of the following keys as quickly and accurately as possible:</p>
                
                <div class="key-instruction">
                    Press <strong>B</strong> if the target is PRESENT<br>
                    Press <strong>N</strong> if the target is NOT present
                </div>

                <p style="margin-top: 20px;">You have 4 seconds to respond to each stimulus. If you don't respond in time, the trial will be marked as too slow.</p>
                <p>There will be 50 trials in total. Take breaks if needed between trials.</p>
            </div>

            <div class="button-container">
                <button onclick="startTrials()">Begin Trials</button>
            </div>
        </div>

        <!-- Trial Section -->
        <div id="trialSection" class="section">
            <h1>Navon Task - Trial</h1>
            <div class="participant-info">
                Participant Number: <span id="trialParticipantId"></span>
            </div>
            
            <div class="trial-counter">
                Trial <span id="currentTrial">1</span> of <span id="totalTrials">50</span>
            </div>

            <div class="progress-info">
                <div style="width: 100%; background-color: #e0e0e0; border-radius: 4px; overflow: hidden;">
                    <div id="progressBar" style="width: 0%; height: 30px; background-color: var(--color-primary); transition: width 0.3s; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">0%</div>
                </div>
            </div>

            <div class="stimulus-container">
                <div id="stimulus" class="stimulus-text"></div>
            </div>

            <div id="feedbackContainer" style="display: none;">
                <div id="feedbackMessage" class="feedback-message"></div>
            </div>

            <div class="key-instruction">
                Press <strong>B</strong> = Present | <strong>N</strong> = Not Present<br>
                <span style="font-size: 0.9em; font-weight: normal;">You have 4 seconds to respond</span>
            </div>
        </div>

        <!-- Results Section -->
        <div id="resultsSection" class="section">
            <h1>Navon Task - Results</h1>
            <div class="participant-info">
                Participant Number: <span id="resultsParticipantId"></span>
            </div>

            <h2>Trial Data</h2>
            <table id="resultsTable">
                <thead>
                    <tr>
                        <th>Trial</th>
                        <th>Stimulus</th>
                        <th>Level</th>
                        <th>Target Present</th>
                        <th>Response</th>
                        <th>Correct</th>
                        <th>RT (ms)</th>
                    </tr>
                </thead>
                <tbody id="resultsTableBody">
                </tbody>
            </table>

            <h2>Summary Statistics</h2>
            <div class="feedback-section">
                <div class="feedback-row">
                    <span class="feedback-label">Total Trials Completed:</span>
                    <span class="feedback-value" id="totalCompleted">0</span>
                </div>
                <div class="feedback-row">
                    <span class="feedback-label">Overall Accuracy:</span>
                    <span class="feedback-value" id="overallAccuracy">0%</span>
                </div>
                <div class="feedback-row">
                    <span class="feedback-label">Mean Reaction Time:</span>
                    <span class="feedback-value" id="meanRT">0 ms</span>
                </div>
            </div>

            <h2>Reaction Times by Condition</h2>
            <div class="feedback-section">
                <div class="feedback-row">
                    <span class="feedback-label">Global Level (H or O) RT:</span>
                    <span class="feedback-value" id="globalRT">— ms</span>
                </div>
                <div class="feedback-row">
                    <span class="feedback-label">Local Level (h or o) RT:</span>
                    <span class="feedback-value" id="localRT">— ms</span>
                </div>
                <div class="feedback-row">
                    <span class="feedback-label">No Target RT:</span>
                    <span class="feedback-value" id="noneRT">— ms</span>
                </div>
            </div>

            <h2>Error Counts by Condition</h2>
            <div class="feedback-section">
                <div class="feedback-row">
                    <span class="feedback-label">Global Level (H or O) Errors:</span>
                    <span class="feedback-value" id="globalErrors">0</span>
                </div>
                <div class="feedback-row">
                    <span class="feedback-label">Local Level (h or o) Errors:</span>
                    <span class="feedback-value" id="localErrors">0</span>
                </div>
                <div class="feedback-row">
                    <span class="feedback-label">No Target Errors:</span>
                    <span class="feedback-value" id="noneErrors">0</span>
                </div>
            </div>

            <div class="button-container">
                <button class="print-button" onclick="window.print()">Print Results</button>
                <button class="restart-button" onclick="restartExperiment()">Run Another Participant</button>
            </div>
        </div>
    </div>

    <script>
        // Stimulus configurations from source code
        const stimuliConfig = [
            { id: 'Lu', global: 'L', local: 'u', level: 'none', target: 0, correctKey: 'N' },
            { id: 'Uo', global: 'U', local: 'o', level: 'local', target: 1, correctKey: 'B' },
            { id: 'Uu', global: 'U', local: 'u', level: 'none', target: 0, correctKey: 'N' },
            { id: 'Ul', global: 'U', local: 'l', level: 'none', target: 0, correctKey: 'N' },
            { id: 'Ll', global: 'L', local: 'l', level: 'none', target: 0, correctKey: 'N' },
            { id: 'Lo', global: 'L', local: 'o', level: 'local', target: 1, correctKey: 'B' },
            { id: 'Ou', global: 'O', local: 'u', level: 'global', target: 2, correctKey: 'B' },
            { id: 'Ol', global: 'O', local: 'l', level: 'global', target: 2, correctKey: 'B' },
            { id: 'Tt', global: 'T', local: 't', level: 'none', target: 0, correctKey: 'N' },
            { id: 'Ts', global: 'T', local: 's', level: 'none', target: 0, correctKey: 'N' },
            { id: 'Th', global: 'T', local: 'h', level: 'local', target: 1, correctKey: 'B' },
            { id: 'St', global: 'S', local: 't', level: 'none', target: 0, correctKey: 'N' },
            { id: 'Ss', global: 'S', local: 's', level: 'none', target: 0, correctKey: 'N' },
            { id: 'Sh', global: 'S', local: 'h', level: 'local', target: 1, correctKey: 'B' },
            { id: 'Ht', global: 'H', local: 't', level: 'global', target: 2, correctKey: 'B' },
            { id: 'Hs', global: 'H', local: 's', level: 'global', target: 2, correctKey: 'B' }
        ];

        // Generate stimulus display (local letters form global letter)
        function generateStimulusDisplay(config) {
            const globalLetter = config.global;
            const localLetter = config.local;
            const size = globalLetter === 'O' ? '200px' : '180px';
            
            // Create a visual representation
            return `<div style="font-size: ${size}; line-height: 0.9; letter-spacing: -5px; color: #000; font-weight: bold; text-align: center;">${localLetter}${localLetter}${localLetter}</div><div style="font-size: 10px; margin-top: 10px; color: #666;">(${globalLetter} made of ${localLetter}'s)</div>`;
        }

        // Experiment state
        let participantId = '';
        let trials = [];
        let currentTrialIndex = 0;
        let trialData = [];
        let timeoutId = null;
        let responseGiven = false;
        let trialStartTime = 0;

        // Generate trial sequence (50 trials, randomized with all_before_repeat logic)
        function generateTrials() {
            trials = [];
            let stimulusPool = [...stimuliConfig];
            
            // Repeat until we have 50 trials
            while (trials.length < 50) {
                if (stimulusPool.length === 0) {
                    stimulusPool = [...stimuliConfig];
                }
                // Shuffle and pick from remaining
                const randomIndex = Math.floor(Math.random() * stimulusPool.length);
                trials.push(stimulusPool[randomIndex]);
                stimulusPool.splice(randomIndex, 1);
            }
            
            return trials.slice(0, 50);
        }

        // Validation
        function validateParticipantId(id) {
            return /^\d{3}$/.test(id);
        }

        // Start experiment
        function startExperiment() {
            participantId = document.getElementById('participantId').value;
            const errorDiv = document.getElementById('idError');
            
            if (!validateParticipantId(participantId)) {
                errorDiv.style.display = 'block';
                return;
            }
            
            errorDiv.style.display = 'none';
            trialData = [];
            generateTrials();
            
            showSection('instructionSection');
            document.getElementById('displayParticipantId').textContent = participantId;
        }

        // Start trials
        function startTrials() {
            currentTrialIndex = 0;
            showSection('trialSection');
            document.getElementById('trialParticipantId').textContent = participantId;
            document.getElementById('totalTrials').textContent = trials.length;
            presentTrial();
        }

        // Present trial
        function presentTrial() {
            if (currentTrialIndex >= trials.length) {
                showResults();
                return;
            }

            responseGiven = false;
            const trial = trials[currentTrialIndex];
            const trialNum = currentTrialIndex + 1;
            
            document.getElementById('currentTrial').textContent = trialNum;
            document.getElementById('stimulus').innerHTML = generateStimulusDisplay(trial);
            document.getElementById('feedbackContainer').style.display = 'none';
            
            // Update progress bar
            const progress = Math.round((currentTrialIndex / trials.length) * 100);
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('progressBar').textContent = progress + '%';
            
            trialStartTime = Date.now();
            
            // Set timeout
            timeoutId = setTimeout(() => {
                if (!responseGiven) {
                    handleResponse('TIMEOUT', trial);
                }
            }, 4000);
            
            // Listen for keyboard input
            document.addEventListener('keydown', handleKeyPress);
        }

        // Handle key press
        function handleKeyPress(event) {
            if (responseGiven) return;
            
            const key = event.key.toLowerCase();
            if (key !== 'b' && key !== 'n') return;
            
            event.preventDefault();
            document.removeEventListener('keydown', handleKeyPress);
            responseGiven = true;
            clearTimeout(timeoutId);
            
            const trial = trials[currentTrialIndex];
            const rt = Date.now() - trialStartTime;
            
            // Determine if correct
            const correct = (key === 'b') === (trial.correctKey === 'B');
            const status = correct ? 'CORRECT' : 'WRONG';
            
            // Store trial data
            trialData.push({
                trialNum: currentTrialIndex + 1,
                stimulus: trial.id,
                global: trial.global,
                local: trial.local,
                level: trial.level,
                target: trial.target,
                targetPresent: trial.correctKey === 'B',
                response: key === 'b' ? 'Present' : 'Not Present',
                correct: correct ? 1 : 0,
                status: status,
                rt: rt
            });
            
            handleResponse(status, trial, rt);
        }

        // Handle response
        function handleResponse(status, trial, rt) {
            document.removeEventListener('keydown', handleKeyPress);
            const feedbackContainer = document.getElementById('feedbackContainer');
            const feedbackMessage = document.getElementById('feedbackMessage');
            
            feedbackContainer.style.display = 'block';
            
            if (status === 'CORRECT') {
                feedbackMessage.className = 'feedback-message feedback-correct';
                feedbackMessage.textContent = '✓ Correct!';
            } else if (status === 'WRONG') {
                feedbackMessage.className = 'feedback-message feedback-wrong';
                feedbackMessage.textContent = '✗ Wrong!';
            } else if (status === 'TIMEOUT') {
                feedbackMessage.className = 'feedback-message feedback-tooslow';
                feedbackMessage.textContent = 'Too Slow!';
                rt = 4000;
            }
            
            // Wait 1 second before next trial
            setTimeout(() => {
                currentTrialIndex++;
                presentTrial();
            }, 1500);
        }

        // Show results
        function showResults() {
            showSection('resultsSection');
            document.getElementById('resultsParticipantId').textContent = participantId;
            
            // Populate results table
            const tbody = document.getElementById('resultsTableBody');
            tbody.innerHTML = '';
            
            trialData.forEach(trial => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${trial.trialNum}</td>
                    <td>${trial.stimulus}</td>
                    <td>${trial.level === 'global' ? 'Global' : trial.level === 'local' ? 'Local' : 'None'}</td>
                    <td>${trial.targetPresent ? 'Yes' : 'No'}</td>
                    <td>${trial.response}</td>
                    <td style="color: ${trial.correct ? 'green' : 'red'}; font-weight: bold;">${trial.correct ? 'Yes' : 'No'}</td>
                    <td>${trial.rt}</td>
                `;
                tbody.appendChild(row);
            });
            
            // Calculate summary statistics
            calculateStatistics();
        }

        // Calculate statistics
        function calculateStatistics() {
            const correct = trialData.filter(t => t.correct === 1);
            const accuracy = ((correct.length / trialData.length) * 100).toFixed(1);
            const meanRT = (trialData.reduce((sum, t) => sum + t.rt, 0) / trialData.length).toFixed(0);
            
            document.getElementById('totalCompleted').textContent = trialData.length;
            document.getElementById('overallAccuracy').textContent = accuracy + '%';
            document.getElementById('meanRT').textContent = meanRT + ' ms';
            
            // By condition statistics
            const globalTrials = trialData.filter(t => t.target === 2 && t.correct === 1);
            const localTrials = trialData.filter(t => t.target === 1 && t.correct === 1);
            const noneTrials = trialData.filter(t => t.target === 0 && t.correct === 1);
            
            const globalRT = globalTrials.length > 0 
                ? (globalTrials.reduce((sum, t) => sum + t.rt, 0) / globalTrials.length).toFixed(0) 
                : '—';
            const localRT = localTrials.length > 0 
                ? (localTrials.reduce((sum, t) => sum + t.rt, 0) / localTrials.length).toFixed(0) 
                : '—';
            const noneRT = noneTrials.length > 0 
                ? (noneTrials.reduce((sum, t) => sum + t.rt, 0) / noneTrials.length).toFixed(0) 
                : '—';
            
            document.getElementById('globalRT').textContent = (globalRT !== '—' ? globalRT + ' ms' : globalRT);
            document.getElementById('localRT').textContent = (localRT !== '—' ? localRT + ' ms' : localRT);
            document.getElementById('noneRT').textContent = (noneRT !== '—' ? noneRT + ' ms' : noneRT);
            
            // Error counts
            const globalErrors = trialData.filter(t => t.target === 2 && t.correct === 0).length;
            const localErrors = trialData.filter(t => t.target === 1 && t.correct === 0).length;
            const noneErrors = trialData.filter(t => t.target === 0 && t.correct === 0).length;
            
            document.getElementById('globalErrors').textContent = globalErrors;
            document.getElementById('localErrors').textContent = localErrors;
            document.getElementById('noneErrors').textContent = noneErrors;
        }

        // Show section
        function showSection(sectionId) {
            const sections = document.querySelectorAll('.section');
            sections.forEach(s => s.classList.remove('active'));
            document.getElementById(sectionId).classList.add('active');
        }

        // Restart experiment
        function restartExperiment() {
            participantId = '';
            trials = [];
            currentTrialIndex = 0;
            trialData = [];
            document.getElementById('participantId').value = '';
            showSection('entrySection');
        }

        // Allow Enter key to start
        document.getElementById('participantId')?.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') startExperiment();
        });
    </script>
</body>
</html>
